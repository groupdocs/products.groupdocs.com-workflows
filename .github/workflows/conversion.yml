name: Conversion
env:
    product_family: "conversion"
    supported_locales: "en de es fa fr id it ja ko pt ru th uk vi zh"
    
on:
  push:
    branches: [ main, production ]
    paths:
       - 'content/conversion/**'
  pull_request:
    branches: [ main, production ]

  repository_dispatch:
    types: [staging-complete, production-complete]
    
  # Allows the workflow run manually from the Actions tab
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deploy_scope:
        description: 'What to deploy'
        required: true
        default: 'index_pages_only'
        type: choice
        options:
          - pages_and_sitemap
          - index_pages_only

jobs:
  # This workflow contains a single job called "deploy"
  deploy:
    name: Deploy ${{ (github.event_name == 'workflow_dispatch' && inputs.environment) || (github.event_name == 'repository_dispatch' && github.event.action == 'production-complete' && 'production') || (github.ref == 'refs/heads/production' && 'production') || 'staging' }} (scope=${{ (github.event_name == 'workflow_dispatch' && inputs.deploy_scope) || 'pages_and_sitemap' }})
    # The type of runner that the job will run on
    runs-on: macos-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - name: Checkout theme repo
      uses: actions/checkout@main
      with:
          repository: groupdocs/products.groupdocs.com
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
          hugo-version: '0.101.0'
          extended: true

    - name: Determine environment
      id: cfg
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "base_url=https://products.groupdocs.com/" >> $GITHUB_OUTPUT
          echo "bucket=products.groupdocs.com" >> $GITHUB_OUTPUT
          echo "hugo_config=./$product_family-production-config.toml" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "repository_dispatch" ] && [ "${{ github.event.action }}" = "production-complete" ]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "base_url=https://products.groupdocs.com/" >> $GITHUB_OUTPUT
          echo "bucket=products.groupdocs.com" >> $GITHUB_OUTPUT
          echo "hugo_config=./$product_family-production-config.toml" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/production" ]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "base_url=https://products.groupdocs.com/" >> $GITHUB_OUTPUT
          echo "bucket=products.groupdocs.com" >> $GITHUB_OUTPUT
          echo "hugo_config=./$product_family-production-config.toml" >> $GITHUB_OUTPUT
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "base_url=https://products-qa.groupdocs.com/" >> $GITHUB_OUTPUT
          echo "bucket=products-qa.groupdocs.com" >> $GITHUB_OUTPUT
          echo "hugo_config=./$product_family-staging-config.toml" >> $GITHUB_OUTPUT
        fi

        # Determine scope: default to pages_and_sitemap except when manually chosen as index_pages_only
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.deploy_scope }}" = "index_pages_only" ]; then
          echo "scope=index_pages_only" >> $GITHUB_OUTPUT
        else
          echo "scope=pages_and_sitemap" >> $GITHUB_OUTPUT
        fi
 
    - name: Filter content based on scope
      run: |
        if [ "${{ steps.cfg.outputs.scope }}" = "index_pages_only" ]; then
          find ./content -mindepth 1 -type f -not -regex "./content/$product_family/.*_index.*" -delete
        else
          find ./content -mindepth 1 ! -regex "^./content/$product_family\(/.*\)?" -delete
        fi
        ls -la content/;

    - name: Build pages
      run: hugo --config "${{ steps.cfg.outputs.hugo_config }}" -b "${{ steps.cfg.outputs.base_url }}" --disableKinds=taxonomy,category --cleanDestinationDir --minify
      
    - name: Prepare public folder
      run: |
        if [ "${{ steps.cfg.outputs.scope }}" = "pages_and_sitemap" ]; then
          mv public/sitemap.xml public/$product_family.xml;
          rm public/index.html;
          mkdir public_home;
          mkdir public_home/sitemaps;
          mv public/$product_family.xml public_home/sitemaps/;
        else
          rm public/index.html;
        fi
        
    - name: Upload family sitemap
      if: ${{ steps.cfg.outputs.scope == 'pages_and_sitemap' }}
      run: AWS_ACCESS_KEY_ID=${{ secrets.ACCESS_KEY }} AWS_SECRET_ACCESS_KEY=${{ secrets.SECRET_ACCESS}} aws s3 cp public_home/sitemaps/$product_family.xml s3://${{ steps.cfg.outputs.bucket }}/sitemaps/$product_family.xml --content-type application/xml --acl public-read --region us-west-2

    - name: Upload default language
      run: |
        if [ "${{ steps.cfg.outputs.environment }}" = "staging" ]; then
          AWS_ACCESS_KEY_ID=${{ secrets.ACCESS_KEY }} AWS_SECRET_ACCESS_KEY=${{ secrets.SECRET_ACCESS}} aws s3 sync public/$product_family s3://${{ steps.cfg.outputs.bucket }}/$product_family --acl public-read --follow-symlinks --delete --no-progress --region us-west-2
        else
          AWS_ACCESS_KEY_ID=${{ secrets.ACCESS_KEY }} AWS_SECRET_ACCESS_KEY=${{ secrets.SECRET_ACCESS}} aws s3 sync public/$product_family s3://${{ steps.cfg.outputs.bucket }}/$product_family --acl public-read --follow-symlinks --delete --no-progress --region us-west-2
        fi

    - name: Upload localized folders and sitemaps
      run: |
        for lang in ${{ env.supported_locales }}; do
          dir="public/$lang/$product_family"
          if [ -d "$dir" ]; then
            echo "Syncing $dir to s3://${{ steps.cfg.outputs.bucket }}/$lang/$product_family"
            if [ "${{ steps.cfg.outputs.environment }}" = "staging" ]; then
              AWS_ACCESS_KEY_ID=${{ secrets.ACCESS_KEY }} AWS_SECRET_ACCESS_KEY=${{ secrets.SECRET_ACCESS}} aws s3 sync "$dir" "s3://${{ steps.cfg.outputs.bucket }}/$lang/$product_family" --acl public-read --follow-symlinks --delete --no-progress --region us-west-2
            else
              AWS_ACCESS_KEY_ID=${{ secrets.ACCESS_KEY }} AWS_SECRET_ACCESS_KEY=${{ secrets.SECRET_ACCESS}} aws s3 sync "$dir" "s3://${{ steps.cfg.outputs.bucket }}/$lang/$product_family" --acl public-read --no-progress --region us-west-2
            fi
          fi
          sm="public/$lang/sitemap.xml"
          if [ "${{ steps.cfg.outputs.scope }}" = "pages_and_sitemap" ] && [ -f "$sm" ]; then
            echo "Uploading $sm to s3://${{ steps.cfg.outputs.bucket }}/$lang/$product_family/sitemap.xml"
            AWS_ACCESS_KEY_ID=${{ secrets.ACCESS_KEY }} AWS_SECRET_ACCESS_KEY=${{ secrets.SECRET_ACCESS}} aws s3 cp "$sm" "s3://${{ steps.cfg.outputs.bucket }}/$lang/$product_family/sitemap.xml" --content-type application/xml --acl public-read --region us-west-2
          fi
        done

    - name: Invalidate cache
      env:
        API_ENDPOINT: ${{ secrets.CACHE_INVALIDATION_API_ENDPOINT }}
      run: |
        # Invalidate root (default locale) paths
        curl --write-out '%{http_code}' --silent --output /dev/null -d '{"website":"${{ steps.cfg.outputs.base_url }}${{ env.product_family }}/*"}' -H "Content-Type: application/json" -X POST "$API_ENDPOINT"
        # Invalidate per-locale paths (include 'en')
        for lang in en $supported_locales; do
          curl --write-out '%{http_code}' --silent --output /dev/null -d "{\"website\":\"${{ steps.cfg.outputs.base_url }}$lang/${{ env.product_family }}/*\"}" -H "Content-Type: application/json" -X POST "$API_ENDPOINT"
        done

